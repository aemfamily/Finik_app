<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SmartFinance Cloud ‚Äî –û–±—â–∏–π –±—é–¥–∂–µ—Ç</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-app: #F5F7FA; --bg-card: #FFFFFF; --bg-input: #F3F4F6;
            --primary: #4F46E5; --primary-grad: linear-gradient(135deg, #4F46E5, #818CF8);
            --success: #059669; --danger: #E11D48; --warning: #D97706;
            --text-main: #1F2937; --text-muted: #6B7280;
            --radius-xl: 32px; --radius-lg: 16px;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-app); color: var(--text-main); margin: 0; padding: 15px; display: flex; justify-content: center; }
        .app-container { width: 100%; max-width: 440px; padding-bottom: 50px; }

        /* Balance Card */
        .header-card {
            background: var(--primary-grad); color: white; padding: 35px 25px;
            border-radius: var(--radius-xl); text-align: center; margin-bottom: 25px;
            box-shadow: 0 15px 30px -10px rgba(79, 70, 229, 0.4);
        }
        .balance-val { font-size: 2.8rem; font-weight: 800; letter-spacing: -1px; margin: 10px 0; }
        .month-label { text-transform: uppercase; font-size: 0.75rem; font-weight: 700; opacity: 0.8; letter-spacing: 1px; }

        .card { background: var(--bg-card); border-radius: var(--radius-xl); padding: 24px; margin-bottom: 20px; box-shadow: 0 10px 25px -5px rgba(0,0,0,0.05); }
        h2 { font-size: 1rem; font-weight: 700; margin: 0 0 15px 0; color: var(--text-main); }

        /* Controls */
        .segmented-control { display: flex; background: var(--bg-input); padding: 4px; border-radius: var(--radius-lg); margin-bottom: 15px; }
        .segment-btn { flex: 1; border: none; padding: 10px; border-radius: 12px; font-weight: 600; cursor: pointer; color: var(--text-muted); background: transparent; transition: 0.2s; }
        .segment-btn.active { background: white; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        .chips { display: flex; gap: 8px; margin-bottom: 15px; }
        .chip { padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--bg-input); cursor: pointer; background: none; color: var(--text-muted); }
        .chip.active.mand { background: #FFFBEB; color: var(--warning); border-color: var(--warning); }
        .chip.active.opt { background: #EEF2FF; color: var(--primary); border-color: var(--primary); }

        .input-group { display: flex; gap: 10px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 16px; border: none; background: var(--bg-input); border-radius: var(--radius-lg); font-size: 1rem; outline: none; }
        
        .btn-main { width: 100%; border: none; padding: 16px; border-radius: var(--radius-lg); font-size: 1rem; font-weight: 700; color: white; cursor: pointer; background: var(--primary-grad); }
        .btn-main.exp { background: linear-gradient(135deg, #E11D48, #F43F5E); }

        /* History */
        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--bg-input); }
        .item-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .item-amt { font-weight: 700; font-size: 1rem; text-align: right; }
        .carry-link { font-size: 0.7rem; color: var(--primary); font-weight: 700; cursor: pointer; margin-top: 4px; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: flex-end; backdrop-filter: blur(5px); }
        .modal-content { background: white; width: 100%; border-radius: 32px 32px 0 0; padding: 30px 25px; box-sizing: border-box; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px; }
        .day-cell { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 0.85rem; background: var(--bg-app); }
        .day-cell.active { background: var(--primary); color: white; font-weight: 700; }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header-card">
        <div class="month-label" id="monthName">–ú–µ—Å—è—Ü...</div>
        <div class="balance-val" id="totalBalance">0 ‚Ç∏</div>
        <div style="opacity: 0.8; font-weight: 500;">–û–±–ª–∞—á–Ω—ã–π –±—é–¥–∂–µ—Ç</div>
    </header>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px;">
        <button class="segment-btn" style="background:white" onclick="openModal('calModal')">üìÖ –î–∞—Ç–∞</button>
        <button class="segment-btn" style="background:white" onclick="openModal('catModal')">‚öôÔ∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
    </div>

    <div class="card">
        <div class="segmented-control">
            <button class="segment-btn active" id="tabInc" onclick="setMode('inc', this)">–î–æ—Ö–æ–¥</button>
            <button class="segment-btn" id="tabExp" onclick="setMode('exp', this)">–†–∞—Å—Ö–æ–¥</button>
        </div>
        <div id="subTypeContainer" style="display:none;">
            <div class="chips">
                <button id="btnMand" class="chip active mand" onclick="setSubType('mandatory', this)">üìå –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ</button>
                <button id="btnOpt" class="chip" onclick="setSubType('optional', this)">‚òï –ü–æ –∂–µ–ª–∞–Ω–∏—é</button>
            </div>
        </div>
        <div class="input-group">
            <input type="number" id="amtIn" placeholder="–°—É–º–º–∞" pattern="\d*">
            <select id="catIn"></select>
        </div>
        <button class="btn-main" id="addBtn" onclick="saveEntry()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –æ–±–ª–∞–∫–æ</button>
    </div>

    <div class="card">
        <h2>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–µ—Å—è—Ü–∞</h2>
        <div style="height: 220px;"><canvas id="chartCanvas"></canvas></div>
    </div>

    <div class="card">
        <h2>–ò—Å—Ç–æ—Ä–∏—è <button onclick="resetFilter()" id="resetBtn" style="display:none; border:none; background:none; color:var(--primary); font-weight:700; cursor:pointer;">–í–µ—Å—å –º–µ—Å—è—Ü</button></h2>
        <div id="histList"></div>
    </div>
</div>

<div id="calModal" class="modal" onclick="if(event.target==this) closeModal('calModal')">
    <div class="modal-content">
        <h2>–í—ã–±–æ—Ä –ø–µ—Ä–∏–æ–¥–∞</h2>
        <input type="month" id="monthPick" onchange="renderCalendar()" style="text-align:center;">
        <div id="calGrid" class="calendar-grid"></div>
    </div>
</div>

<div id="catModal" class="modal" onclick="if(event.target==this) closeModal('catModal')">
    <div class="modal-content">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h2>
        <div id="catEditList" style="margin-bottom:15px"></div>
        <div class="input-group">
            <input type="text" id="newCatName" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
            <button class="btn-main" onclick="addCat()" style="width:70px">+</button>
        </div>
    </div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE (–í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï –¢–£–¢) ---
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
          apiKey: "AIzaSyCwLIVkDnWI3jfhGeTWNir6qtCiqK_WyEY",
          authDomain: "familybukh-8589b.firebaseapp.com",
          projectId: "familybukh-8589b",
          storageBucket: "familybukh-8589b.firebasestorage.app",
          messagingSenderId: "216401295308",
          appId: "1:216401295308:web:19a1abe363a954eb73cf69",
          measurementId: "G-LC7NQ27KNF"
        };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let app = {
        data: [],
        cats: JSON.parse(localStorage.getItem('sf_v15_cats')) || { inc: ['–ó–∞—Ä–ø–ª–∞—Ç–∞'], exp: ['–ü—Ä–æ–¥—É–∫—Ç—ã', '–ñ–∏–ª—å–µ'] },
        mode: 'inc', subMode: 'mandatory',
        selDate: new Date().toISOString().substring(0, 10),
        view: 'month', chart: null
    };

    window.onload = () => {
        document.getElementById('monthPick').value = app.selDate.substring(0, 7);
        syncWithFirebase();
    };

    // --- FIREBASE SYNC ---
    function syncWithFirebase() {
        database.ref('entries').on('value', (snapshot) => {
            const cloudData = snapshot.val();
            app.data = cloudData ? Object.entries(cloudData).map(([key, val]) => ({...val, fbKey: key})) : [];
            updateUI();
        });
    }

    function saveEntry() {
        const val = parseFloat(document.getElementById('amtIn').value);
        const cat = document.getElementById('catIn').value;
        if(val > 0 && cat) {
            const newEntry = {
                date: app.selDate, amt: val, cat: cat, 
                type: app.mode, sub: app.mode === 'exp' ? app.subMode : 'none',
                createdAt: Date.now()
            };
            database.ref('entries').push(newEntry);
            document.getElementById('amtIn').value = '';
        }
    }

    function delItem(fbKey) {
        if(confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞?')) database.ref('entries/' + fbKey).remove();
    }

    function carryOver(fbKey) {
        const item = app.data.find(i => i.fbKey === fbKey);
        let parts = item.date.split('-'); 
        let d = new Date(parts[0], parts[1] - 1, parts[2]);
        d.setMonth(d.getMonth() + 1);
        const nextDate = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        
        database.ref('entries').push({...item, date: nextDate, createdAt: Date.now(), fbKey: null});
        alert('–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ!');
    }

    // --- UI LOGIC ---
    function setMode(m, btn) {
        app.mode = m;
        document.querySelectorAll('.segment-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById('subTypeContainer').style.display = m === 'exp' ? 'block' : 'none';
        document.getElementById('addBtn').classList.toggle('exp', m === 'exp');
        renderCatSelect();
    }

    function setSubType(s, btn) {
        app.subMode = s;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active', 'mand', 'opt'));
        btn.classList.add('active', s === 'mandatory' ? 'mand' : 'opt');
    }

    function updateUI() {
        const mStr = document.getElementById('monthPick').value;
        const monthly = app.data.filter(i => i.date.startsWith(mStr));
        const daily = app.data.filter(i => i.date === app.selDate);
        const display = app.view === 'month' ? monthly : daily;

        document.getElementById('monthName').innerText = new Date(mStr + "-01").toLocaleString('ru', { month: 'long', year: 'numeric' });
        
        const inc = monthly.filter(i => i.type === 'inc').reduce((s, i) => s + i.amt, 0);
        const exp = monthly.filter(i => i.type === 'exp').reduce((s, i) => s + i.amt, 0);
        document.getElementById('totalBalance').innerText = (inc - exp).toLocaleString() + ' ‚Ç∏';

        document.getElementById('resetBtn').style.display = app.view === 'day' ? 'inline-block' : 'none';
        document.getElementById('histList').innerHTML = display.sort((a,b) => b.createdAt - a.createdAt).map(i => `
            <div class="history-item">
                <div style="display:flex; align-items:center; gap:12px">
                    <div class="item-icon" style="background:${i.type === 'inc' ? '#ECFDF5':'#FFF1F2'}; color:${i.type === 'inc' ? '#059669':'#E11D48'}">${i.type === 'inc'?'‚Üì':'‚Üë'}</div>
                    <div>
                        <div style="font-weight:700">${i.sub==='mandatory'?'üìå ':''}${i.cat}</div>
                        <div style="font-size:0.75rem; color:var(--text-muted)">${i.date}</div>
                    </div>
                </div>
                <div style="text-align:right">
                    <div class="item-amt" style="color:${i.type==='inc'?'var(--success)':'var(--text-main)'}">${i.type==='inc'?'+':'-'}${i.amt.toLocaleString()}</div>
                    ${i.sub==='mandatory' ? `<div class="carry-link" onclick="carryOver('${i.fbKey}')">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ ‚Üí</div>`:''}
                </div>
                <button onclick="delItem('${i.fbKey}')" style="border:none; background:none; color:#CCC; font-size:1.2rem; margin-left:10px">√ó</button>
            </div>
        `).join('') || '<div style="text-align:center; padding:30px; color:#CCC">–ü—É—Å—Ç–æ</div>';

        renderCatSelect(); drawChart(monthly);
    }

    function renderCatSelect() {
        document.getElementById('catIn').innerHTML = app.cats[app.mode].map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function renderCatEdit(type) {
        document.getElementById('catEditList').innerHTML = app.cats[type].map((c, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #EEE">
                <span>${c}</span>
                <button onclick="delCat('${type}', ${i})" style="color:red; background:none; border:none">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        `).join('');
    }

    function addCat() {
        const n = document.getElementById('newCatName').value;
        const t = app.mode; // —É–ø—Ä–æ—Å—Ç–∏–ª
        if(n) { app.cats[t].push(n); localStorage.setItem('sf_v15_cats', JSON.stringify(app.cats)); updateUI(); }
    }

    function delCat(t, i) { app.cats[t].splice(i, 1); localStorage.setItem('sf_v15_cats', JSON.stringify(app.cats)); updateUI(); }

    function drawChart(data) {
        const ctx = document.getElementById('chartCanvas').getContext('2d');
        if(app.chart) app.chart.destroy();
        const mand = data.filter(i => i.sub === 'mandatory').reduce((s, i) => s + i.amt, 0);
        const opt = data.filter(i => i.sub === 'optional').reduce((s, i) => s + i.amt, 0);
        const inc = data.filter(i => i.type === 'inc').reduce((s, i) => s + i.amt, 0);
        const free = inc - (mand + opt);

        app.chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['–ë–∞–∑–∞', '–î–æ—Å—É–≥', '–°–≤–æ–±–æ–¥–Ω–æ'],
                datasets: [{
                    data: [mand, opt, free > 0 ? free : 0],
                    backgroundColor: ['#D97706', '#4F46E5', '#059669'],
                    borderWidth: 0
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'bottom' } } }
        });
    }

    function openModal(id) { document.getElementById(id).style.display = 'flex'; if(id==='calModal') renderCalendar(); if(id==='catModal') renderCatEdit('exp'); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function resetFilter() { app.view = 'month'; updateUI(); }
    
    function renderCalendar() {
        const mVal = document.getElementById('monthPick').value;
        const grid = document.getElementById('calGrid'); grid.innerHTML = '';
        const [y, m] = mVal.split('-').map(Number);
        const days = new Date(y, m, 0).getDate();
        const start = new Date(y, m-1, 1).getDay();
        const offset = start === 0 ? 6 : start - 1;
        for (let i = 0; i < offset; i++) grid.appendChild(document.createElement('div'));
        for (let d = 1; d <= days; d++) {
            const dateStr = `${mVal}-${String(d).padStart(2, '0')}`;
            const cell = document.createElement('div');
            cell.className = 'day-cell' + (dateStr === app.selDate ? ' active' : '');
            cell.innerText = d;
            cell.onclick = () => { app.selDate = dateStr; app.view = 'day'; closeModal('calModal'); updateUI(); };
            grid.appendChild(cell);
        }
    }
</script>
</body>
</html>
